(()=>{"use strict";var t,e=function(t,e,n,a){if("a"===n&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?a:"a"===n?a.call(t):a?a.value:e.get(t)};class n{constructor({tagName:n="div",classes:a=[],textContent:s="",parent:r=null,attributes:i=null}){t.set(this,void 0),function(t,e,n,a,s){if("m"===a)throw new TypeError("Private method is not writable");if("a"===a&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===a?s.call(t,n):s?s.value=n:e.set(t,n)}(this,t,document.createElement(n),"f"),e(this,t,"f").classList.add(...a),s.length>0&&(e(this,t,"f").textContent=s),this.setAttributes(i),this.appendTo(r)}setAttributes(n){null!==n&&void 0!==e(this,t,"f")&&Object.entries(n).forEach((([n,a])=>{e(this,t,"f").setAttribute(n,a)}))}appendTo(n){n instanceof HTMLElement&&n.append(e(this,t,"f"))}getNode(){return e(this,t,"f")}}t=new WeakMap;class a{constructor(t,e){this.elements={},this.createElements(t,e)}createElements(t,e){t.forEach((t=>{const{value:a}=t,s=new n(a),r="string"==typeof a.parent?this.resolveParent(a.parent):e;s.appendTo(r),this.elements[t.key]=s.getNode()}))}resolveParent(t){const e=t.split(".").reduce(((t,e)=>t[e]),this.elements);if(!(e instanceof HTMLElement))throw new TypeError("Parent should be HTMLElement");return e}getElements(){return this.elements}}const s=t=>t instanceof HTMLButtonElement,r=t=>t instanceof HTMLInputElement,i=t=>t instanceof HTMLElement;var o=function(t,e,n,a){return new(n||(n=Promise))((function(s,r){function i(t){try{c(a.next(t))}catch(t){r(t)}}function o(t){try{c(a.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,o)}c((a=a.apply(t,e||[])).next())}))};class c{static getCars(t){return o(this,void 0,void 0,(function*(){const e=yield fetch(`${this.baseUrl}/garage?_page=${t}&_limit=7`),n=yield e.json(),a=e.headers.get("X-Total-Count");if(null===a)throw new Error("can't get cars amount");return{cars:n,totalCount:+a}}))}static getCar(t){return o(this,void 0,void 0,(function*(){const e=yield fetch(`${this.baseUrl}/garage/${t}`);return yield e.json()}))}static createCar(t){return o(this,void 0,void 0,(function*(){const e=yield fetch(`${this.baseUrl}/garage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});return yield e.json()}))}static deleteCar(t){return o(this,void 0,void 0,(function*(){try{return yield fetch(`${this.baseUrl}/garage/${t}`,{method:"DELETE"})}catch(t){return void console.warn(t)}}))}static updateCar(t,e){return o(this,void 0,void 0,(function*(){return(yield fetch(`${this.baseUrl}/garage/${t}`,{method:"PUT",headers:{"content-type":"application/json"},body:JSON.stringify(e)})).ok}))}static toggleEngine(t,e){return o(this,void 0,void 0,(function*(){const n=`?id=${t}&status=${e}`,a=yield fetch(`${this.baseUrl}/engine/${n}`,{method:"PATCH"});return yield a.json()}))}static driveMode(t){return o(this,void 0,void 0,(function*(){try{const e=`?id=${t}&status=drive`,n=yield fetch(`${this.baseUrl}/engine/${e}`,{method:"PATCH"});if(n.ok)return"success";if(404===n.status)throw new Error("404");return n}catch(t){return void console.log("catching stale engine break")}}))}static getWinners(t,e,n){return o(this,void 0,void 0,(function*(){const a=yield fetch(`${this.baseUrl}/winners?_page=${t}&_limit=10&_sort=${e}&_order=${n}`),s=yield a.json(),r=a.headers.get("X-Total-Count");if(null===r)throw new Error("can't get winners amount");return{winners:s,totalCount:+r}}))}static getWinner(t){return o(this,void 0,void 0,(function*(){const e=yield fetch(`${this.baseUrl}/winners/${t}`);return e.ok?yield e.json():null}))}static createWinner(t){return o(this,void 0,void 0,(function*(){yield fetch(`${this.baseUrl}/winners`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}))}static deleteWinner(t){return o(this,void 0,void 0,(function*(){try{if(!(yield fetch(`${this.baseUrl}/winners/${t}`,{method:"DELETE"})).ok)throw new Error("This car never won, no need to delete it from winners db")}catch(t){console.warn(t.message)}}))}static updateWinner(t,e){return o(this,void 0,void 0,(function*(){yield fetch(`${this.baseUrl}/winners/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}))}}c.baseUrl="https://async-race-01u9.onrender.com";const l={HONDA:["ACCORD","CAPA","CIVIC","CONCERTO","CR-V","CR-Z","CROSSTOUR","CRX","FR-V","HR-V","INSIGHT","INTEGRA","JAZZ","LEGEND","LOGO","NSX","ODYSSEY","PILOT-I","PILOT-II","PILOT-III","PRELUDE","QUINTET","S2000","SHUTTLE","STREAM"],MERCEDES:["100","190","A-CLASS","AMG","B-CLASS","C-CLASS","CABRIOLET","CITAN","CLA","CLC-CLASS","CLK","CLS","COUPE","E-CLASS","G-CLASS","GL-CLASS","GLA-CLASS","GLC","GLE","GLK-CLASS","GLS","KOMBI","M-CLASS","R-CLASS","S-CLASS","SEDAN","SL","SLC","SLK","SLR","SLS","SPRINTER","T1","T1-TN","T2-LN1","V-CLASS","VANEO","VARIO","VIANO","VITO"],JAGUAR:["E-PACE","F-PACE","F-TYPE","S-TYPE","X-TYPE","XE","XF","XJ","XJ220","XJSC","XK"],SUBARU:["BRZ","FORESTER","IMPREZA","JUSTY","LEGACY","LEONE","LEVORG","LIBERO","OUTBACK","REX","SVX","TREZIA","TRIBECA","VIVIO","WRX","XT","XV"],VOLKSWAGEN:["AMAROK","ARTEON","BEETLE","BORA","CADDY","CORRADO","CRAFTER","DERBY","EOS","FOX","GOLF","JETTA","LT","LUPO","MULTIVAN","NEW - BEETLE","PASSAT","PHAETON","POLO","ROUTAN","SANTANA","SCIROCCO","SHARAN","TARO","TIGUAN","TOUAREG","TOURAN","TRANSPORTER","UP","VENTO","XL1"],TOYOTA:["4 - RUNNER","ALLION","ALPHARD","ALTEZZA","ARISTO","AURIS","AVALON","AVENSIS","AYGO","BREVIS","C - HR","CALDINA","CAMI","CAMRY","CARIBE","CARINA","CAVALIER","CELICA","CELSIOR","CENTURY","CHASER","COROLLA","CORONA","CRESSIDA","CRESTA","CROWN","DUET","DYNA","ECHO","FJ - CRUISER","FORTUNER","GAIA","GT","HARRIER","HIACE","HIGHLANDER","HILUX","IQ","ISIS","IST","LAND - CRUISER","LITEACE","MARK","MATRIX","MIRAI","MODELL","MR","NADIA","VOXY","OPA","PASEO","PICNIC","PLATZ","PORTE","PREMIO","PREVIA","PRIUS","PROACE","PROBOX","PROGRES","RACTIS","RAUM","RAV - 4","RUSH","SEQUOIA","SIENNA","SOLARA","SPRINTER","STARLET","SUPRA","TERCEL","TOWN","TUNDRA","URBAN","VANGUARD","VENZA","VEROSSA","VERSO","VIOS","YARIS","WISH","YARIS"],PORSCHE:["718","911","918","944","959","968","BOXSTER","CARRERA","CAYENNE","CAYMAN","MACAN","PANAMERA"],VOLVO:["440","460","480","740","760","780","850","940","960","C30","C70","S40","S60","S70","S80","S90","V40","V50","V60","V70","V90","XC60","XC70","XC90"]},d=()=>{const t=Object.keys(l),e=t[Math.floor(Math.random()*t.length)],n=l[e];return`${e} ${n[Math.floor(Math.random()*n.length)]}`},h=()=>{let t="";for(let e=0;e<3;e++)t+=Math.floor(256*Math.random()).toString(16);return`#${t.padStart(6,"0")}`},g=t=>{console.warn(t)},u=(t,e)=>{t.forEach((t=>{s(t)&&(t.disabled=e)}))},m=(t,e,n)=>{const{toFirstPage:a,toPrevPage:s,toNextPage:r,toLastPage:i}=n;switch(!0){case 1===t&&1===e:u([a,s,r,i],!0);break;case 1===t:u([a,s],!0),u([r,i],!1);break;case t>1&&t<e:u([a,s,r,i],!1);break;case t===e:u([a,s],!1),u([r,i],!0)}},v='<svg version="1.0" xmlns="http://www.w3.org/2000/svg"\nwidth="80px" height="40px" viewBox="0 0 1280.000000 640.000000"\npreserveAspectRatio="xMidYMid meet" fill="#000000" stroke="none">\n<g transform="translate(0.000000,640.000000) scale(0.100000,-0.100000)">\n<path d="M3525 5341 c-72 -18 -79 -28 -90 -121 -4 -30 -11 -62 -16 -71 -4 -9\n-97 -51 -206 -94 -774 -304 -1348 -540 -1603 -661 -163 -77 -222 -91 -421\n-104 -85 -5 -170 -14 -189 -20 -101 -32 -362 -58 -620 -63 l-115 -2 -47 -80\nc-47 -78 -47 -80 -29 -100 34 -36 35 -77 5 -177 -30 -99 -34 -178 -19 -370 5\n-67 4 -88 -6 -88 -29 0 -83 -56 -110 -114 -50 -106 -74 -343 -48 -467 13 -58\n13 -62 3 -159 -5 -54 16 -238 28 -244 2 -1 29 -20 61 -41 73 -49 123 -103 132\n-143 17 -79 167 -155 355 -181 104 -15 969 -97 1087 -104 l32 -2 5 160 c7 230\n50 394 146 559 281 479 917 673 1405 429 316 -159 530 -424 598 -742 22 -106\n29 -365 13 -519 l-8 -82 3002 0 c2855 0 3002 1 2995 18 -33 87 -56 325 -45\n461 28 320 177 567 459 759 399 273 847 282 1243 24 239 -157 397 -392 460\n-687 18 -84 15 -341 -5 -430 -8 -38 -14 -71 -12 -73 7 -8 386 20 478 34 180\n28 253 65 304 152 24 41 28 57 28 127 -1 44 -9 117 -20 163 -18 79 -18 88 -2\n190 31 199 40 306 41 497 1 176 -1 195 -23 260 -46 135 -103 190 -283 274\n-222 104 -633 220 -1168 330 -523 108 -1524 210 -2054 211 l-229 0 -236 139\nc-813 477 -1593 884 -1852 966 -498 157 -1598 195 -2892 100 l-188 -14 -47 30\nc-92 58 -223 89 -297 70z m1912 -311 c13 -45 58 -305 88 -515 33 -226 74 -539\n71 -542 -7 -7 -1672 40 -2054 58 -357 16 -464 56 -573 215 -62 91 -87 225 -59\n326 12 40 56 74 192 148 369 198 799 289 1618 340 246 15 290 16 510 16 l194\n-1 13 -45z m649 10 c383 -36 717 -86 934 -139 210 -52 451 -163 720 -332 141\n-88 379 -259 380 -271 0 -5 -14 -8 -32 -8 -48 0 -114 -37 -140 -78 -24 -39\n-30 -113 -15 -189 l9 -43 -904 0 -904 0 -176 540 -175 540 47 0 c25 0 141 -9\n256 -20z"/>\n<path d="M2617 3125 c-431 -82 -774 -440 -838 -875 -17 -117 -7 -292 24 -410\n113 -436 497 -751 947 -777 507 -29 959 313 1076 813 28 117 26 348 -4 467\n-94 378 -383 670 -760 768 -105 27 -336 34 -445 14z m378 -310 c84 -21 209\n-85 280 -142 116 -94 210 -242 251 -393 23 -87 24 -260 0 -355 -58 -237 -242\n-439 -473 -519 -531 -186 -1074 277 -969 828 30 152 94 274 206 386 111 110\n237 178 385 206 84 16 235 11 320 -11z"/>\n<path d="M2918 2568 c2 -90 7 -167 12 -172 17 -17 108 58 201 166 l51 57 -48\n31 c-52 33 -131 65 -185 75 l-34 6 3 -163z"/>\n<path d="M2591 2700 c-62 -22 -167 -82 -164 -94 3 -13 237 -216 249 -216 7 0\n15 7 18 16 8 20 8 127 -1 232 -7 95 -8 96 -102 62z"/>\n<path d="M3209 2355 c-57 -64 -105 -123 -107 -131 -6 -25 46 -35 157 -29 58 3\n121 8 139 11 33 5 34 6 27 42 -7 44 -64 167 -92 201 l-19 24 -105 -118z"/>\n<path d="M2260 2409 c-31 -44 -68 -133 -77 -186 l-6 -33 155 0 c165 0 201 9\n181 44 -13 24 -204 216 -214 216 -5 0 -22 -18 -39 -41z"/>\n<path d="M2786 2354 c-36 -35 0 -87 44 -64 26 14 26 56 1 70 -25 13 -27 13\n-45 -6z"/>\n<path d="M2751 2186 c-57 -32 -68 -111 -22 -157 43 -42 101 -43 143 -1 42 42\n41 100 -1 143 -33 32 -78 38 -120 15z"/>\n<path d="M2560 2136 c-19 -23 -8 -61 18 -64 44 -7 67 32 36 62 -19 20 -38 20\n-54 2z"/>\n<path d="M3002 2124 c-27 -19 -28 -36 -3 -58 25 -23 61 -6 61 29 0 33 -30 49\n-58 29z"/>\n<path d="M2245 1993 c-77 -6 -76 -5 -59 -65 16 -55 61 -146 92 -186 l18 -23\n103 122 c57 67 104 129 105 138 1 14 -14 16 -104 17 -58 0 -127 -1 -155 -3z"/>\n<path d="M3165 1981 c-44 -4 -61 -10 -63 -22 -3 -16 210 -229 228 -229 22 0\n86 141 105 228 l7 32 -109 -2 c-59 -1 -135 -4 -168 -7z"/>\n<path d="M2776 1914 c-19 -18 -19 -20 -6 -45 6 -11 21 -19 35 -19 20 0 45 24\n45 44 0 10 -32 36 -45 36 -7 0 -21 -7 -29 -16z"/>\n<path d="M2589 1743 c-86 -90 -139 -151 -139 -162 0 -25 179 -101 236 -101\nl27 0 -7 143 c-9 166 -13 187 -35 187 -9 0 -46 -30 -82 -67z"/>\n<path d="M2936 1801 c-6 -10 -24 -168 -29 -258 -3 -60 -2 -63 19 -63 79 0 262\n68 248 92 -5 7 -53 64 -108 126 -93 105 -117 124 -130 103z"/>\n<path d="M10723 3125 c-318 -58 -597 -266 -743 -555 -223 -441 -98 -996 289\n-1288 112 -84 188 -125 311 -166 274 -91 545 -70 802 61 552 282 735 983 392\n1500 -225 339 -651 521 -1051 448z m385 -315 c348 -98 579 -443 532 -796 -67\n-508 -596 -796 -1055 -574 -239 116 -396 352 -412 620 -20 335 192 640 516\n745 122 40 289 42 419 5z"/>\n<path d="M11017 2568 c3 -90 9 -167 14 -172 13 -14 53 18 155 122 l95 97 -23\n18 c-50 40 -189 97 -235 97 -10 0 -11 -33 -6 -162z"/>\n<path d="M10705 2706 c-50 -16 -133 -58 -163 -82 l-23 -19 121 -107 c67 -60\n128 -108 135 -108 23 0 27 39 20 186 -8 162 -4 157 -90 130z"/>\n<path d="M11307 2354 c-59 -65 -107 -126 -107 -136 0 -11 11 -18 38 -22 44 -7\n278 7 289 17 15 16 -51 183 -94 236 l-19 24 -107 -119z"/>\n<path d="M10362 2413 c-39 -62 -70 -134 -78 -184 l-7 -39 152 0 c86 0 161 5\n172 10 17 10 18 13 5 38 -8 15 -59 71 -114 125 l-99 99 -31 -49z"/>\n<path d="M10888 2359 c-24 -14 -23 -56 2 -69 44 -23 80 29 44 64 -18 19 -23\n19 -46 5z"/>\n<path d="M10851 2187 c-49 -29 -66 -101 -35 -146 9 -13 32 -29 50 -37 29 -12\n39 -12 68 0 99 41 85 180 -19 192 -24 3 -50 -1 -64 -9z"/>\n<path d="M10660 2136 c-19 -23 -8 -61 18 -64 44 -7 67 32 36 62 -19 20 -38 20\n-54 2z"/>\n<path d="M11096 2124 c-9 -8 -16 -22 -16 -29 0 -13 26 -45 36 -45 20 0 44 25\n44 45 0 14 -8 29 -19 35 -25 13 -27 13 -45 -6z"/>\n<path d="M10335 1991 c-60 -6 -60 -6 -57 -36 9 -69 104 -248 122 -229 57 61\n210 250 207 258 -4 12 -176 17 -272 7z"/>\n<path d="M11267 1983 c-68 -5 -79 -19 -47 -60 23 -31 200 -193 210 -193 3 0\n20 24 37 53 29 48 52 111 67 180 l6 27 -107 -2 c-60 -1 -134 -3 -166 -5z"/>\n<path d="M10870 1910 c-16 -31 4 -62 38 -58 21 2 28 9 30 32 5 45 -47 65 -68\n26z"/>\n<path d="M10651 1703 c-56 -59 -101 -113 -101 -120 0 -28 172 -103 237 -103\nl26 0 -7 123 c-10 179 -15 207 -36 207 -10 0 -63 -48 -119 -107z"/>\n<path d="M11035 1801 c-7 -12 -23 -144 -29 -243 -4 -77 -4 -78 19 -78 45 0\n130 22 193 51 l64 29 -19 23 c-65 82 -198 227 -209 227 -7 0 -15 -4 -19 -9z"/>\n</g>\n</svg>',p=[{key:"container",value:{classes:["garage__car","car"]}},{key:"name",value:{tagName:"span",classes:["car__name"],parent:"container"}},{key:"controls",value:{classes:["car__controls"],parent:"container"}},{key:"startEngineBtn",value:{tagName:"button",classes:["car__button","car__button--start"],parent:"controls"}},{key:"stopEngineBtn",value:{tagName:"button",classes:["car__button","car__button--stop"],parent:"controls"}},{key:"modifyBtn",value:{tagName:"button",classes:["car__button","car__button--modify"],parent:"controls"}},{key:"deleteBtn",value:{tagName:"button",classes:["car__button","car__button--delete"],parent:"controls"}},{key:"image",value:{classes:["car__image"],parent:"container"}},{key:"road",value:{classes:["car__road"],parent:"container"}}],C=[{key:"container",value:{tagName:"dialog",classes:["car-creation__container"]}},{key:"nameInput",value:{tagName:"input",classes:["car-creation__name-input"],attributes:{type:"text"},parent:"container"}},{key:"colorPicker",value:{tagName:"input",classes:["car-creation__color-picker"],attributes:{type:"color"},parent:"container"}},{key:"createBtn",value:{tagName:"button",classes:["car-creation__submit-btn"],textContent:"create",parent:"container"}}],w=[{key:"garage",value:{classes:["garage"]}},{key:"overlay",value:{classes:["overlay"],attributes:{title:"Reset cars to garage first, they must be in a safe place :)"}}},{key:"title",value:{tagName:"h2",classes:["garage__title"],parent:"garage"}},{key:"controls",value:{classes:["garage__controls"],parent:"garage"}},{key:"createCarBtn",value:{tagName:"button",classes:["controls__button","controls__button--create-car"],textContent:"+1",attributes:{title:"Add car"},parent:"controls"}},{key:"generateCarsBtn",value:{tagName:"button",classes:["controls__button","controls__button--generate-cars"],textContent:"+100",attributes:{title:"Add 100 cars"},parent:"controls"}},{key:"startBtn",value:{tagName:"button",classes:["controls__button","controls__button--start-race"],textContent:"race",attributes:{title:"Start race"},parent:"controls"}},{key:"resetBtn",value:{tagName:"button",classes:["controls__button","controls__button--reset-race"],textContent:"reset",attributes:{title:"End race"},parent:"controls"}},{key:"paginationBtns",value:{classes:["garage__pagination","pagination"],parent:"garage"}},{key:"toFirstPage",value:{tagName:"button",classes:["button","pagination__toInit"],textContent:"<<",parent:"paginationBtns"}},{key:"toPrevPage",value:{tagName:"button",classes:["button","pagination__toPrev"],textContent:"<",parent:"paginationBtns"}},{key:"currentPageEl",value:{classes:["button","pagination__current"],parent:"paginationBtns"}},{key:"toNextPage",value:{tagName:"button",classes:["button","pagination__toNext"],textContent:">",parent:"paginationBtns"}},{key:"toLastPage",value:{tagName:"button",classes:["button","pagination__toLast"],textContent:">>",parent:"paginationBtns"}},{key:"carElements",value:{classes:["garage__car-elements"],parent:"garage"}}];class E{constructor(t){this.garage={},this.cars=[],this.createCarPopup={},this.init(t)}init(t){this.garage=new a(w,t).getElements(),this.switchRaceBtns()}createCarElement(t){var e;const{carElements:n}=this.garage,s=new a(p,n).getElements(),{name:r,image:i,controls:o}=s;return r.textContent=t.name,i.innerHTML=v,i.children[0].setAttribute("fill",t.color),o.dataset.id=(null!==(e=t.id)&&void 0!==e?e:0).toString(),o.dataset.color=t.color,o.dataset.name=t.name,s}modifyElementsContent({totalItems:t,currentPage:e,totalPages:n}={}){const{title:a,currentPageEl:s}=this.garage;void 0!==t&&(a.textContent=`Cars in garage: ${t}`),void 0!==e&&void 0!==n&&(s.textContent=`${e.toString()} / ${n.toString()}`)}switchRaceBtns(){const{startBtn:t,resetBtn:e}=this.garage;u([e],!0),u([t],!1)}toggleCarBtns(t,e){const{startEngineBtn:n,stopEngineBtn:a,modifyBtn:r,deleteBtn:i}=t;[n,a,r,i].forEach((t=>{s(t)&&(t.disabled="started"===e)}))}toggleStopBtn(t){const{stopEngineBtn:e}=t;s(e)&&(e.disabled=!e.disabled)}clearCarsPage(){this.garage.carElements.innerHTML=""}showCreateCar(t,e){this.createCarPopup=new a(C,t).getElements(),this.changeCarPopupValues("create"),this.createCarPopup.createBtn.addEventListener("click",e);const n=this.createCarPopup.container;n instanceof HTMLDialogElement&&n.showModal()}showModifyCar(t,e){if(void 0!==this.createCarPopup.container)return;const{id:n,name:a,color:s}=t,r=this.getCarElement(null!=n?n:0);void 0!==r&&(this.showCreateCar(r.container,(()=>{e(null!=n?n:0).catch(g)})),this.changeCarPopupValues("modify",{name:a,color:s}))}changeCarPopupValues(t,e){var n,a;const{nameInput:s,colorPicker:i,createBtn:o}=this.createCarPopup;r(s)&&r(i)&&(s.value="modify"===t?null!==(n=null==e?void 0:e.name)&&void 0!==n?n:"":d(),i.value="modify"===t?null!==(a=null==e?void 0:e.color)&&void 0!==a?a:"":h(),o.textContent="modify"===t?"update":"create")}removeCarPopup(){const{container:t}=this.createCarPopup;void 0!==t&&(t.remove(),delete this.createCarPopup.container)}removeStoredCar(t){this.cars=this.cars.filter((e=>e.controls.dataset.id!==t.toString()))}extractInputValues(){const{nameInput:t,colorPicker:e}=this.createCarPopup;if(!r(t)||!r(e))throw new TypeError("not an input element :(");return{name:t.value,color:e.value}}modifyCarElement(t){const{id:e,color:n,name:a}=t,r=this.getCarElement(null!=e?e:0);if(void 0===r)return;r.name.textContent=a,r.image.children[0].setAttribute("fill",n),r.controls.dataset.color=n,r.controls.dataset.name=a,this.removeCarPopup();const{createCarBtn:i}=this.garage;s(i)&&(i.disabled=!1)}getCarElement(t){const e=this.cars.find((e=>e.controls.dataset.id===t.toString()));if(void 0===e)throw new Error("can't find car element");return e}moveCar(t,e){const{carElements:n}=this.garage,a=[{transform:"translateX(0px"},{transform:"translateX("+(n.clientWidth-e.clientWidth-20+"px")}],s={duration:t,fill:"forwards"};return e.animate(a,s)}showWinner(t,e){this.garage.winnerPopup=new n({classes:["garage__winner"],textContent:`${t.name} wins in ${(e/1e3).toFixed(2)}seconds`,parent:this.garage.garage}).getNode()}hideWinner(){const{winnerPopup:t}=this.garage;i(t)&&(t.remove(),delete this.garage.winnerPopup)}disableButtonsOnRace(){const{startBtn:t,resetBtn:e,toFirstPage:n,createCarBtn:a,overlay:s}=this.garage,{toLastPage:r,toNextPage:i,toPrevPage:o,generateCarsBtn:c}=this.garage;u([t,e,n,r,i,o,a,c],!0),s.style.display="block"}enableButtonsAfterRace(t,e){const{startBtn:n,createCarBtn:a,generateCarsBtn:s,overlay:r,resetBtn:i}=this.garage;r.style.display="none",u([n,a,s],!1),u([i],!0),m(t,e,this.garage)}}var f=function(t,e,n,a){return new(n||(n=Promise))((function(s,r){function i(t){try{c(a.next(t))}catch(t){r(t)}}function o(t){try{c(a.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,o)}c((a=a.apply(t,e||[])).next())}))};class y{constructor(t,e){this.state=e,this.raceMode=!1,this.racePromises=[],this.view=new E(t),this.init()}init(){this.addListenersToPage(),m(1,1,this.view.garage),this.fillGarage().catch(g)}addCar(t,e){return f(this,void 0,void 0,(function*(){const n=yield c.createCar({name:t,color:e});this.renderCarsToPageLimit(n);const a=this.state.garage.totalPages;this.state.changeTotalItemsCount("add","garage");const{totalItems:s,currentPage:r,totalPages:i}=this.state.garage;this.view.modifyElementsContent({totalItems:s,currentPage:r,totalPages:i}),a!==i&&m(r,i,this.view.garage),this.view.removeCarPopup()}))}deleteCar(t){return f(this,void 0,void 0,(function*(){yield c.deleteCar(t),0===this.view.cars.length&&this.state.handleEmptyPage("garage"),yield this.fillGarage(),yield c.deleteWinner(t)}))}modifyCar(t){return f(this,void 0,void 0,(function*(){const{name:e,color:n}=this.view.extractInputValues();yield c.updateCar(t,{name:e,color:n}),this.view.modifyCarElement({id:t,name:e,color:n})}))}toggleEngine(t,e,n){var a;return f(this,void 0,void 0,(function*(){try{"started"===e&&this.view.toggleCarBtns(n,e),"stopped"===e&&this.view.toggleStopBtn(n);const{velocity:a,distance:s}=yield c.toggleEngine(t,e);if("stopped"===e&&this.view.toggleCarBtns(n,e),this.view.toggleStopBtn(n),0===a)throw this.state.garage.carsAtStart+=1,new Error("engine stopped");this.state.garage.carsAtStart-=1;const r=Math.round(s/a);n.animation=this.view.moveCar(r,n.image);const i=this.toDriveMode(t,n.animation,r);this.racePromises.push(i)}catch(t){if(7===this.state.garage.carsAtStart){this.view.hideWinner();const{currentPage:t,totalPages:e}=this.state.garage;this.view.enableButtonsAfterRace(t,e),this.raceMode=!1}this.raceMode||(this.racePromises.length=0),null===(a=n.animation)||void 0===a||a.cancel(),delete n.animation}}))}toDriveMode(t,e,n){return f(this,void 0,void 0,(function*(){try{const e=yield c.driveMode(t);if("string"==typeof e)return{id:t,time:n};if(void 0===e)throw new Error;const{status:a}=e,s=yield e.text();if(404===a)throw new Error("404");if(500===a)throw new Error(s);return}catch(t){if("404"===t.message)return;if(e.pause(),console.warn(t.message),this.raceMode)throw new Error("engine stopped");return}}))}handleWinner(t,e){return f(this,void 0,void 0,(function*(){const n=yield c.getCar(t);this.view.showWinner(n,e);const a=+(e/1e3).toFixed(2);yield this.setWinner(t,a)}))}setWinner(t,e){return f(this,void 0,void 0,(function*(){try{const n=yield c.getWinner(t);if(null===n)throw new Error("no record");let{time:a,wins:s}=n;e<a&&(a=e),s+=1,yield c.updateWinner(t,{time:a,wins:s})}catch(n){"no record"===n.message&&(console.warn("This car wins first time, creating new record"),yield c.createWinner({id:t,wins:1,time:e}))}}))}addListenersToPage(){const{createCarBtn:t,generateCarsBtn:e,controls:n,paginationBtns:a}=this.view.garage;t.addEventListener("click",(()=>{this.view.showCreateCar(n,(()=>{const{name:t,color:e}=this.view.extractInputValues();this.addCar(t,e).catch(g)}))})),e.addEventListener("click",this.generateCars.bind(this)),a.addEventListener("click",this.switchPage.bind(this));const{startBtn:s,resetBtn:r}=this.view.garage;s.addEventListener("click",(()=>{this.view.disableButtonsOnRace(),this.toggleRace("started").catch(g)})),r.addEventListener("click",(()=>{this.view.hideWinner(),u([r],!0),this.toggleRace("stopped").catch(g)}))}switchPage(t){if(!(t.target instanceof HTMLButtonElement))return;this.state.setCurrentPage(t,"garage");const{currentPage:e,totalPages:n}=this.state.garage;m(e,n,this.view.garage),this.view.hideWinner(),this.view.modifyElementsContent({currentPage:e,totalPages:n}),this.fillGarage().catch(g)}fillGarage(){return f(this,void 0,void 0,(function*(){const{currentPage:t}=this.state.garage,{cars:e,totalCount:n}=yield c.getCars(t);this.state.garage.totalItems=n;const{totalItems:a,totalPages:s}=this.state.garage;this.view.modifyElementsContent({totalItems:a,currentPage:t,totalPages:s}),this.view.cars.length=0,this.view.clearCarsPage(),e.forEach((t=>this.renderCarsToPageLimit(t))),m(t,s,this.view.garage)}))}renderCarsToPageLimit(t){const{itemsPerPage:e}=this.state.garage;if(this.view.cars.length<e){const e=this.view.createCarElement(t);this.addListenersToCar(e),this.view.cars.push(e)}}addListenersToCar(t){const{startEngineBtn:e,stopEngineBtn:n,deleteBtn:a,modifyBtn:r}=t;if(!s(e)||!s(n))throw new TypeError("not a button element :(");n.disabled=!0,a.addEventListener("click",(t=>{this.handleCarBtn(t,"delete")})),r.addEventListener("click",(t=>{this.handleCarBtn(t,"modify")})),e.addEventListener("click",(t=>{this.view.disableButtonsOnRace();const{resetBtn:e}=this.view.garage;u([e],!1),this.handleCarBtn(t,"started")})),n.addEventListener("click",(t=>{this.handleCarBtn(t,"stopped")}))}handleCarBtn(t,e){var n,a,s;const r=(t=>{var e,n,a;if(!i(t.target))throw new Error("can't find car element");const s=t.target.parentElement;return{id:+(null!==(e=null==s?void 0:s.dataset.id)&&void 0!==e?e:0),name:null!==(n=null==s?void 0:s.dataset.name)&&void 0!==n?n:"",color:null!==(a=null==s?void 0:s.dataset.color)&&void 0!==a?a:""}})(t),o=this.view.getCarElement(null!==(n=r.id)&&void 0!==n?n:0);switch(e){case"delete":this.deleteCar(null!==(a=r.id)&&void 0!==a?a:0).catch(g);break;case"modify":this.view.showModifyCar(r,this.modifyCar.bind(this));break;case"started":case"stopped":this.toggleEngine(null!==(s=r.id)&&void 0!==s?s:0,e,o).catch(g)}}generateCars(){for(let t=0;t<100;t++){const t=d(),e=h();this.addCar(t,e).catch(g)}}toggleRace(t){return f(this,void 0,void 0,(function*(){this.raceMode=!0;const e=[];this.view.cars.forEach((n=>{var a;const s=null!==(a=n.controls.dataset.id)&&void 0!==a?a:0,r=this.toggleEngine(+s,t,n);e.push(r)})),yield Promise.all(e),"stopped"===t?this.handleRaceReset():this.handleRaceWinner().catch(g)}))}handleRaceReset(){const{currentPage:t,totalPages:e}=this.state.garage;this.view.enableButtonsAfterRace(t,e),this.raceMode=!1}handleRaceWinner(){return f(this,void 0,void 0,(function*(){try{const t=yield Promise.any(this.racePromises);if(void 0===t)return;const{id:e,time:n}=t;this.handleWinner(e,n).catch(g),yield Promise.allSettled(this.racePromises)}catch(t){console.warn("all cars broken")}finally{const{resetBtn:t}=this.view.garage;u([t],!1),this.racePromises.length=0}}))}}const P=[{key:"header",value:{tagName:"header",classes:["header"]}},{key:"garageBtn",value:{tagName:"button",classes:["button","header__button","header__button--garage"],textContent:"Garage",parent:"header"}},{key:"winnersBtn",value:{tagName:"button",classes:["button","header__button","header__button--winners"],textContent:"Winners",parent:"header"}}],A=[{key:"container",value:{classes:["winners__element","element"]}},{key:"number",value:{classes:["element__number"],parent:"container"}},{key:"img",value:{classes:["element__img"],parent:"container"}},{key:"name",value:{classes:["element__name"],parent:"container"}},{key:"wins",value:{classes:["element__wins"],parent:"container"}},{key:"time",value:{classes:["element__time"],parent:"container"}}],S=[{key:"winners",value:{classes:["winners"]}},{key:"title",value:{tagName:"h2",classes:["winners__title"],parent:"winners"}},{key:"paginationBtns",value:{classes:["winners__pagination","pagination"],parent:"winners"}},{key:"toFirstPage",value:{tagName:"button",classes:["button","pagination__toInit"],textContent:"<<",parent:"paginationBtns"}},{key:"toPrevPage",value:{tagName:"button",classes:["button","pagination__toPrev"],textContent:"<",parent:"paginationBtns"}},{key:"currentPageEl",value:{classes:["button","pagination__current"],parent:"paginationBtns"}},{key:"toNextPage",value:{tagName:"button",classes:["button","pagination__toNext"],textContent:">",parent:"paginationBtns"}},{key:"toLastPage",value:{tagName:"button",classes:["button","pagination__toLast"],textContent:">>",parent:"paginationBtns"}},{key:"container",value:{classes:["winners__container"],parent:"winners"}},{key:"controls",value:{classes:["winners__controls"],parent:"container"}},{key:"number",value:{tagName:"div",classes:["controls__number"],textContent:"№",parent:"controls"}},{key:"car",value:{tagName:"div",classes:["controls__car"],textContent:"CAR",parent:"controls"}},{key:"name",value:{tagName:"div",classes:["controls__name"],textContent:"NAME",parent:"controls"}},{key:"wins",value:{tagName:"button",classes:["controls__wins"],textContent:"WINS",parent:"controls"}},{key:"time",value:{tagName:"button",classes:["controls__time"],textContent:"TIME",parent:"controls"}},{key:"winnerElements",value:{classes:["winners__winner-elements"],parent:"container"}}];class R{constructor(t){this.winners={},this.winners=new a(S,t).getElements()}modifyElementsContent({totalItems:t,currentPage:e,totalPages:n}={}){const{title:a,currentPageEl:s}=this.winners;void 0!==t&&(a.textContent=`Total winners: ${t}`),void 0!==e&&void 0!==n&&(s.textContent=`${e.toString()} / ${n.toString()}`)}clearWinnersPage(){this.winners.winnerElements.innerHTML=""}createWinnerElement(t,e,n){const{winnerElements:s}=this.winners,r=new a(A,s).getElements(),{number:i,img:o,name:c,wins:l,time:d}=r;i.textContent=n.toString(),o.innerHTML=v,o.children[0].setAttribute("fill",e.color),c.textContent=e.name,l.textContent=t.wins.toString(),d.textContent=t.time.toString()}}var b=function(t,e,n,a){return new(n||(n=Promise))((function(s,r){function i(t){try{c(a.next(t))}catch(t){r(t)}}function o(t){try{c(a.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,o)}c((a=a.apply(t,e||[])).next())}))};class _{constructor(t,e){this.state=e,this.view=new R(t),m(1,1,this.view.winners),this.init().catch(g)}init(){return b(this,void 0,void 0,(function*(){this.addListeners(),yield this.fillWinners();const{currentPage:t,totalPages:e}=this.state.winners;m(t,e,this.view.winners)}))}fillWinners(){return b(this,void 0,void 0,(function*(){const{currentPage:t,sortBy:e,sortOrder:n}=this.state.winners,{winners:a,totalCount:s}=yield c.getWinners(t,e,n);this.state.winners.totalItems=s;const{totalItems:r,totalPages:i}=this.state.winners;this.view.modifyElementsContent({totalItems:r,currentPage:t,totalPages:i}),this.view.clearWinnersPage();const o=a.map(((e,n)=>b(this,void 0,void 0,(function*(){const a=yield c.getCar(e.id),s=10*t-9+n;this.view.createWinnerElement(e,a,s)}))));yield Promise.allSettled(o)}))}addListeners(){const{time:t,wins:e,paginationBtns:n}=this.view.winners;t.addEventListener("click",(()=>this.handleSortClick("time"))),e.addEventListener("click",(()=>this.handleSortClick("wins"))),n.addEventListener("click",this.switchPage.bind(this))}handleSortClick(t){this.state.handleSort(t),this.fillWinners().catch(g)}switchPage(t){if(!(t.target instanceof HTMLButtonElement))return;this.state.setCurrentPage(t,"winners");const{currentPage:e,totalPages:n}=this.state.winners;m(e,n,this.view.winners),this.view.modifyElementsContent({currentPage:e,totalPages:n}),this.fillWinners().catch(g)}}class L{constructor(){this.garage={currentPage:1,itemsPerPage:7,totalItems:0,carsAtStart:7,get totalPages(){return Math.ceil(this.totalItems/this.itemsPerPage)}},this.winners={currentPage:1,itemsPerPage:10,totalItems:0,sortBy:"wins",sortOrder:"DESC",get totalPages(){return Math.ceil(this.totalItems/this.itemsPerPage)}}}setCurrentPage(t,e){const{currentPage:n,totalPages:a}=this[e],s=((t,e,n)=>{if(i(t.target))switch(t.target.classList[1].slice(-4).toLowerCase()){case"init":return 1;case"prev":if(1===e)return;return e-1;case"next":if(e===n||0===n)return;return e+1;case"last":return n>0?n:1}})(t,n,a);void 0!==s&&(this[e].currentPage=s)}changeTotalItemsCount(t,e){this[e].totalItems="add"===t?++this[e].totalItems:--this[e].totalItems}handleEmptyPage(t){const{currentPage:e}=this[t];this[t].currentPage=e>1?e-1:1}handleSort(t){this.winners.sortBy=t,this.winners.sortOrder="DESC"===this.winners.sortOrder?"ASC":"DESC"}}(new class{constructor(){this.header={},this.state=new L}start(){const t=new n({classes:["container"]}).getNode();this.header=new a(P,t).getElements();const e=new n({tagName:"main",classes:["page"],parent:t}).getNode(),{garageBtn:s,winnersBtn:r}=this.header;s.addEventListener("click",(()=>{e.innerHTML="",this.page=new y(e,this.state),u([s],!0),u([r],!1)})),r.addEventListener("click",(()=>{e.innerHTML="",this.page=new _(e,this.state),u([s],!1),u([r],!0)})),s.click(),document.body.append(t)}}).start()})();